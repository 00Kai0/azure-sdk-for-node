/*** Generated by streamline 0.2.5 - DO NOT EDIT ***/
var __rt=require('streamline/lib/callbacks/runtime').runtime(__filename),__func=__rt.__func,__cb=__rt.__cb,__tryCatch=__rt.__tryCatch,__propagate=__rt.__propagate,__trap=__rt.__trap,__future=__rt.__future,__setEF=__rt.__setEF,__g=__rt.__g;
/*     1 */ var common = require("../common");
/*    20 */ var fs = require("fs");
/*    21 */ var path = require("path");
/*    22 */ var url = require("url");
/*    23 */ var crypto = require("crypto");
/*    24 */ var pfx2pem = require("../../util/certificates/pkcs").pfx2pem;
/*    25 */ var Channel = require("../channel");
/*    26 */ var async = require("async");
/*    27 */ var child_process = require("child_process");
/*    30 */ exports.init = function(cli) {
/*    32 */   var log = cli.output;
/*    34 */   function getChannel() {
/*    35 */     var pem = cli.category("account").managementCertificate();
/*    37 */     var channel = new Channel({
/*    38 */       host: "umapi-preview.core.windows-int.net",
/*    39 */       port: 8443,
/*    40 */       key: pem.key,
/*    41 */       cert: pem.cert
/*    42 */     }).header("x-ms-version", "2011-02-25");
/*    44 */     var proxyString = (((process.env.HTTPS_PROXY || process.env.https_proxy) || process.env.ALL_PROXY) || process.env.all_proxy);
/*    50 */     if ((proxyString !== undefined)) {
/*    51 */       var proxyUrl = url.parse(proxyString);
/*    52 */       if (((proxyUrl.protocol !== "http:") && (proxyUrl.protocol !== "https:"))) {
/*    55 */         proxyUrl = url.parse(("http://" + proxyString));
                  }
                ;
/*    58 */       channel = channel.add({
/*    58 */         proxy: proxyUrl
                  });
                }
              ;
/*    61 */     return channel;
              };
/*    65 */   var site = cli.category("site").description("Commands to manage your web sites");
/*    69 */   site.command("list").description("List your web sites").option("-s, --subscription <id>", "use the subscription id").execute(function __1(options, _) {
                var parameters, spaces, sites;
                var __frame = {
                  name: "__1",
                  line: 72
                };
                return __func(_, this, arguments, __1, 1, __frame, function __$__1() {
/*    73 */       parameters = {
/*    74 */         subscription: cli.category("account").lookupSubscriptionId(options.subscription)
                  };
/*    77 */       return site.doSpacesGet(parameters, __cb(_, __frame, 5, 25, function ___(__0, __1) {
                    spaces = __1;
/*    78 */         return site.doSitesGet(parameters, __cb(_, __frame, 6, 24, function ___(__0, __2) {
                      sites = __2;
/*    80 */           log.table(sites, function(row, site) {
/*    81 */             row.cell("Name", site.Name);
/*    82 */             row.cell("State", site.State);
/*    83 */             row.cell("Host names", clean(site).HostNames);
                      });
                      _();
                    }, true));
                  }, true));
                });
              });
/*    87 */   function choose(data, callback) {
/*    88 */     cli.choose(data, function(x) {
/*    88 */       callback(undefined, x);
                });
              };
/*    90 */   function prompt(label, callback) {
/*    91 */     cli.prompt(label, function(x) {
/*    91 */       callback(undefined, x);
                });
              };
/*    93 */   function confirm(label, callback) {
/*    94 */     cli.confirm(label, function(x) {
/*    94 */       callback(undefined, x);
                });
              };
/*    98 */   site.command("create [name]").description("Create a new web site and local directory").option("-s, --subscription <id>", "use the subscription id").option("--location <location>", "the geographic region to create the website").option("--hostname <hostname>", "custom host name to use").option("--git", "configure git on web site and local folder").execute(function __2(nameArg, options, _) {
                var context;
/*   126 */     function promptForSiteName(_) {
                  var __frame = {
                    name: "promptForSiteName",
                    line: 126
                  };
                  return __func(_, this, arguments, promptForSiteName, 0, __frame, function __$promptForSiteName() {
/*   127 */         log.silly("promptForSiteName");
                    return (function __$promptForSiteName(__then) {
/*   128 */           if ((context.site.name === undefined)) {
/*   129 */             log.help("Need a site name");
/*   130 */             return prompt("Name: ", __cb(_, __frame, 4, 40, function ___(__0, __1) {
/*   130 */               context.site.name = __1;
                          __then();
                        }, true));
                      }
                       else {
                        __then();
                      }
                    ;
                    })(_);
                  });
                };
/*   134 */     function determineIfSiteExists(_) {
                  var sites, hits;
                  var __frame = {
                    name: "determineIfSiteExists",
                    line: 134
                  };
                  return __func(_, this, arguments, determineIfSiteExists, 0, __frame, function __$determineIfSiteExists() {
/*   135 */         log.silly("determineIfSiteExists");
/*   136 */         return site.doSitesGet(context, __cb(_, __frame, 2, 28, function ___(__0, __1) {
                      sites = __1;
/*   137 */           hits = sites.filter(function(item) {
/*   138 */             return (item.Name === context.site.name);
                      });
/*   140 */           if ((hits.length === 1)) {
/*   141 */             log.info("Updating existing site");
/*   142 */             context.flags.siteExists = true;
/*   143 */             if ((context.site.webspace === undefined)) {
/*   144 */               context.site.webspace = hits[0].WebSpace;
/*   145 */               log.verbose("Existing site location is ", context.site.webspace);
                        }
                         else {
/*   146 */               if ((context.site.webspace !== hits[0].WebSpace)) {
/*   147 */                 return _(new Error(((("Expected location " + context.site.webspace) + " but was ") + hits[0].WebSpace)));
                          }
                        ;
                        }
                      ;
                      }
                    ;
                      _();
                    }, true));
                  });
                };
/*   152 */     function promptForLocation(_) {
                  var spaces, displayNameMatches, href;
                  var __frame = {
                    name: "promptForLocation",
                    line: 152
                  };
                  return __func(_, this, arguments, promptForLocation, 0, __frame, function __$promptForLocation() {
/*   153 */         log.silly("promptForLocation");
/*   155 */         return site.doSpacesGet(context, __cb(_, __frame, 3, 29, function ___(__0, __1) {
                      spaces = __1;
/*   157 */           if ((context.site.webspace !== undefined)) {
/*   159 */             displayNameMatches = spaces.filter(function(space) {
/*   160 */               return (space.GeoRegion === context.site.webspace);
                        });
/*   162 */             if ((displayNameMatches.length === 1)) {
/*   163 */               context.site.webspace = displayNameMatches[0].Name;
                        }
                      ;
                      }
                    ;
/*   167 */           if ((context.site.webspace !== undefined)) {
                        return _(null);
                      }
                    ;
                      return (function __$promptForLocation(__then) {
/*   172 */             if ((spaces.length === 0)) {
/*   173 */               log.help("You must create your first web site using the Windows Azure portal.");
/*   174 */               log.help("Please follow these steps in the portal:");
/*   175 */               log.help("1. At the bottom of the page, click on New > Web Site > Quick Create");
/*   176 */               log.help((("2. Type \"" + context.site.name) + "\" in the URL field"));
/*   177 */               log.help("3. Click on \"Create Web Site\"");
/*   178 */               log.help("4. Once the site has been created, click on the site name");
/*   179 */               log.help("5. Click on \"Set up Git publishing\" and create a publishing username and password. Use those credentials for all new websites you create.");
/*   180 */               return confirm("Launch browser to portal now? (y/n) ", __cb(_, __frame, 28, 24, function ___(__0, __2) {
                            return (function __$promptForLocation(__then) {
                              if (__2) {
/*   181 */                     log.help("Launching portal.");
/*   182 */                     href = "https://windows.azure-test.net/";
/*   183 */                     common.launchBrowser(href);
                                __then();
                              }
                               else {
                                __then();
                              }
                            ;
                            })(function __$promptForLocation() {
/*   185 */                   return _(new Error("First site must be created on portal"));
                            });
                          }, true));
                        }
                         else {
                          return (function __$promptForLocation(__then) {
/*   186 */                 if ((spaces.length == 1)) {
/*   187 */                   context.site.webspace = spaces[0].Name;
/*   188 */                   log.info("Using location", context.site.webspace);
                              __then();
                            }
                             else {
/*   190 */                   log.help("Choose a region");
/*   191 */                   return choose(spaces.map(function(space) {
/*   192 */                     return space.GeoRegion;
                              }), __cb(_, __frame, 39, 51, function ___(__0, __3) {
/*   191 */                     context.site.webspace = spaces[__3].Name;
                                __then();
                              }, true));
                            }
                          ;
                          })(__then);
                        }
                      ;
                      })(_);
                    }, true));
                  });
                };
/*   197 */     function determineIfCurrentDirectoryIsGitWorkingTree(_) {
                  var isInsideWorkTree, lines;
                  var __frame = {
                    name: "determineIfCurrentDirectoryIsGitWorkingTree",
                    line: 197
                  };
                  return __func(_, this, arguments, determineIfCurrentDirectoryIsGitWorkingTree, 0, __frame, function __$determineIfCurrentDirectoryIsGitWorkingTree() {
/*   198 */         log.silly("determineIfCurrentDirectoryIsGitWorkingTree");
                    return (function ___(__then) {
                      (function ___(_) {
                        __tryCatch(_, function __$determineIfCurrentDirectoryIsGitWorkingTree() {
/*   201 */               return exec("git rev-parse --is-inside-work-tree", __cb(_, __frame, 4, 43, function ___(__0, __1) {
                            isInsideWorkTree = __1;
/*   202 */                 lines = (isInsideWorkTree.stdout + isInsideWorkTree.stderr);
/*   203 */                 context.flags.isGitWorkingTree = lines.split("\n").some(function(line) {
/*   204 */                   return (line === "true");
                            });
                            __then();
                          }, true));
                        });
                      })(function ___(err, __result) {
                        __tryCatch(_, function __$determineIfCurrentDirectoryIsGitWorkingTree() {
                          if (err) {
/*   207 */                 context.flags.isGitWorkingTree = false;
                            __then();
                          }
                           else {
                            _(null, __result);
                          }
                        ;
                        });
                      });
                    })(function ___() {
                      __tryCatch(_, _);
                    });
                  });
                };
/*   211 */     function initGitOnCurrentDirectory(_) {
                  var __frame = {
                    name: "initGitOnCurrentDirectory",
                    line: 211
                  };
                  return __func(_, this, arguments, initGitOnCurrentDirectory, 0, __frame, function __$initGitOnCurrentDirectory() {
/*   212 */         log.silly("initGitOnCurrentDirectoryIfNeeded");
/*   213 */         if (context.flags.isGitWorkingTree) {
                      return _(null);
                    }
                  ;
/*   217 */         if (!options.git) {
                      return _(null);
                    }
                  ;
/*   221 */         log.info("Executing `git init`");
/*   222 */         return exec("git init", __cb(_, __frame, 11, 16, function __$initGitOnCurrentDirectory() {
                      return (function __$initGitOnCurrentDirectory(__then) {
/*   224 */             if (!path.existsSync(".gitignore")) {
/*   225 */               log.info("Creating default .gitignore file");
/*   226 */               return fs.writeFile(".gitignore", "node_modules", __cb(_, __frame, 15, 20, __then, true));
                        }
                         else {
                          __then();
                        }
                      ;
                      })(function __$initGitOnCurrentDirectory() {
/*   229 */             context.flags.isGitWorkingTree = true;
                        _();
                      });
                    }, true));
                  });
                };
/*   232 */     function copyWebConfigWhenServerJsPresent(_) {
                  var sourcePath;
                  var __frame = {
                    name: "copyWebConfigWhenServerJsPresent",
                    line: 232
                  };
                  return __func(_, this, arguments, copyWebConfigWhenServerJsPresent, 0, __frame, function __$copyWebConfigWhenServerJsPresent() {
/*   233 */         log.silly("copyWebConfigWhenServerJsPresent");
                    return (function __$copyWebConfigWhenServerJsPresent(__then) {
/*   234 */           if ((!path.existsSync("web.config") && path.existsSync("server.js"))) {
/*   235 */             log.info("Creating default web.config file");
/*   236 */             sourcePath = path.join(__dirname, "../templates/node/web.config");
/*   237 */             return fs.readFile(sourcePath, __cb(_, __frame, 5, 47, function ___(__0, __1) {
/*   237 */               return fs.writeFile("web.config", __1, __cb(_, __frame, 5, 20, __then, true));
                        }, true));
                      }
                       else {
                        __then();
                      }
                    ;
                    })(_);
                  });
                };
/*   241 */     function updateLocalConfigWithSiteName(_) {
                  var cfg;
                  var __frame = {
                    name: "updateLocalConfigWithSiteName",
                    line: 241
                  };
                  return __func(_, this, arguments, updateLocalConfigWithSiteName, 0, __frame, function __$updateLocalConfigWithSiteName() {
/*   242 */         log.silly("updateLocalConfigWithSiteName");
                    return (function __$updateLocalConfigWithSiteName(__then) {
/*   243 */           if (context.flags.isGitWorkingTree) {
/*   244 */             return site.readConfig(__cb(_, __frame, 3, 30, function ___(__0, __1) {
                          cfg = __1;
/*   245 */               cfg.name = context.site.name;
/*   246 */               return site.writeConfig(cfg, __cb(_, __frame, 5, 20, __then, true));
                        }, true));
                      }
                       else {
                        __then();
                      }
                    ;
                    })(_);
                  });
                };
/*   250 */     function createSiteAndInitializeRemoteRepo(_) {
                  var __frame = {
                    name: "createSiteAndInitializeRemoteRepo",
                    line: 250
                  };
                  return __func(_, this, arguments, createSiteAndInitializeRemoteRepo, 0, __frame, function __$createSiteAndInitializeRemoteRepo() {
/*   251 */         log.silly("createSiteAndInitializeRemoteRepo");
                    return (function __$createSiteAndInitializeRemoteRepo(__then) {
/*   252 */           if (!context.flags.siteExists) {
/*   253 */             return site.doSitesPost(context, __cb(_, __frame, 3, 20, __then, true));
                      }
                       else {
                        __then();
                      }
                    ;
                    })(function __$createSiteAndInitializeRemoteRepo() {
                      return (function ___(__then) {
                        (function ___(_) {
                          __tryCatch(_, function __$createSiteAndInitializeRemoteRepo() {
/*   256 */                 return site.doRepositoryGet(context, __cb(_, __frame, 6, 35, function ___(__0, __2) {
/*   256 */                   context.repo = __2;
                              __then();
                            }, true));
                          });
                        })(function ___(err, __result) {
                          __tryCatch(_, function __$createSiteAndInitializeRemoteRepo() {
                            if (err) {
/*   259 */                   return site.doRepositoryPost(context, __cb(_, __frame, 9, 20, function __$createSiteAndInitializeRemoteRepo() {
/*   260 */                     return site.doRepositoryGet(context, __cb(_, __frame, 10, 35, function ___(__0, __1) {
/*   260 */                       context.repo = __1;
                                  __then();
                                }, true));
                              }, true));
                            }
                             else {
                              _(null, __result);
                            }
                          ;
                          });
                        });
                      })(function ___() {
                        __tryCatch(_, function __$createSiteAndInitializeRemoteRepo() {
/*   262 */               log.silly("context.repo", context.repo);
                          _();
                        });
                      });
                    });
                  });
                };
/*   265 */     function addRemoteToLocalGitRepo(_) {
                  var publishingUsers, publishingUser, repoUrl, remotes, azureExists;
                  var __frame = {
                    name: "addRemoteToLocalGitRepo",
                    line: 265
                  };
                  return __func(_, this, arguments, addRemoteToLocalGitRepo, 0, __frame, function __$addRemoteToLocalGitRepo() {
/*   266 */         log.silly("addRemoteToLocalGitRepo");
/*   267 */         if (!context.flags.isGitWorkingTree) {
                      return _(null);
                    }
                  ;
/*   270 */         return site.doPublishingUsersGet(context, __cb(_, __frame, 5, 38, function ___(__0, __1) {
                      publishingUsers = __1;
/*   271 */           publishingUser = toArray(publishingUsers)[0];
                      return (function __$addRemoteToLocalGitRepo(__then) {
/*   272 */             if (((publishingUser === undefined) || (publishingUser.length > 64))) {
/*   273 */               log.help("You will also need to provide publishing username and credentials on the portal.");
/*   274 */               log.help("For now, please provide a username for git remote");
/*   275 */               return prompt("Publishing username ", __cb(_, __frame, 10, 37, function ___(__0, __2) {
/*   275 */                 publishingUser = __2;
                            __then();
                          }, true));
                        }
                         else {
                          __then();
                        }
                      ;
                      })(function __$addRemoteToLocalGitRepo() {
/*   278 */             repoUrl = url.parse(((context.repo + context.site.name) + ".git"));
/*   279 */             repoUrl.protocol = "http:";
/*   280 */             repoUrl.auth = publishingUser;
/*   283 */             log.verbose("Detecting git and local git folder");
/*   284 */             return exec("git remote", __cb(_, __frame, 19, 30, function ___(__0, __3) {
                          remotes = __3;
/*   285 */               azureExists = ((remotes.stdout + remotes.stderr)).split("\n").some(function(item) {
/*   286 */                 return (item === "azure");
                          });
                          return (function __$addRemoteToLocalGitRepo(__then) {
/*   289 */                 if (azureExists) {
/*   290 */                   log.verbose("Removing existing azure remote alias");
/*   291 */                   return exec("git remote rm azure", __cb(_, __frame, 26, 20, __then, true));
                            }
                             else {
                              __then();
                            }
                          ;
                          })(function __$addRemoteToLocalGitRepo() {
/*   294 */                 log.info((("Executing `git remote add azure " + url.format(repoUrl)) + "`"));
/*   295 */                 return exec(("git remote add azure " + url.format(repoUrl)), __cb(_, __frame, 30, 16, _, true));
                          });
                        }, true));
                      });
                    }, true));
                  });
                };
                var __frame = {
                  name: "__2",
                  line: 104
                };
                return __func(_, this, arguments, __2, 2, __frame, function __$__2() {
/*   105 */       context = {
/*   106 */         subscription: cli.category("account").lookupSubscriptionId(options.subscription),
/*   107 */         site: {
/*   108 */           name: nameArg,
/*   109 */           webspace: options.location,
/*   110 */           hostname: options.hostname
                    },
/*   112 */         flags: {
                    }
                  };
/*   116 */       return promptForSiteName(__cb(_, __frame, 12, 12, function __$__2() {
/*   117 */         return determineIfSiteExists(__cb(_, __frame, 13, 12, function __$__2() {
/*   118 */           return promptForLocation(__cb(_, __frame, 14, 12, function __$__2() {
/*   119 */             return determineIfCurrentDirectoryIsGitWorkingTree(__cb(_, __frame, 15, 12, function __$__2() {
/*   120 */               return initGitOnCurrentDirectory(__cb(_, __frame, 16, 12, function __$__2() {
/*   121 */                 return copyWebConfigWhenServerJsPresent(__cb(_, __frame, 17, 12, function __$__2() {
/*   122 */                   return updateLocalConfigWithSiteName(__cb(_, __frame, 18, 12, function __$__2() {
/*   123 */                     return createSiteAndInitializeRemoteRepo(__cb(_, __frame, 19, 12, function __$__2() {
/*   124 */                       return addRemoteToLocalGitRepo(__cb(_, __frame, 20, 12, _, true));
                                }, true));
                              }, true));
                            }, true));
                          }, true));
                        }, true));
                      }, true));
                    }, true));
                  }, true));
                });
              });
/*   299 */   site.command("portal [name]").description("Opens the portal in a browser to manage your web sites").execute(function __3(name, options, _) {
                var href;
                var __frame = {
                  name: "__3",
                  line: 301
                };
                return __func(_, this, arguments, __3, 2, __frame, function __$__3() {
/*   303 */       href = "https://windows.azure-test.net/";
/*   304 */       if (name) {
/*   305 */         href = (((href + "#Workspaces/WebsiteExtension/Website/") + name) + "/dashboard");
                  }
                ;
/*   308 */       common.launchBrowser(href);
                  _();
                });
              });
/*   311 */   site.command("browse [name]").description("Open your web site in a browser.").option("-s, --subscription <id>", "use the subscription id").execute(function __4(name, options, _) {
                var context, siteData, href;
                var __frame = {
                  name: "__4",
                  line: 314
                };
                return __func(_, this, arguments, __4, 2, __frame, function __$__4() {
/*   316 */       context = {
/*   317 */         subscription: cli.category("account").lookupSubscriptionId(options.subscription),
/*   318 */         site: {
/*   319 */           name: name
                    }
                  };
/*   322 */       return lookupSiteName(context, __cb(_, __frame, 8, 12, function __$__4() {
/*   323 */         return lookupSiteWebSpace(context, __cb(_, __frame, 9, 12, function __$__4() {
/*   324 */           return site.doSiteGet(context, __cb(_, __frame, 10, 33, function ___(__0, __1) {
/*   324 */             siteData = clean(__1);
/*   326 */             href = ("http://" + toArray(siteData.HostNames)[0]);
/*   328 */             common.launchBrowser(href);
                        _();
                      }, true));
                    }, true));
                  }, true));
                });
              });
/*   331 */   site.command("show [name]").description("Show details for a web sites").option("-s, --subscription <id>", "use the subscription id").execute(function __5(name, options, _) {
                var context, siteData, configData, repositoryData;
                var __frame = {
                  name: "__5",
                  line: 334
                };
                return __func(_, this, arguments, __5, 2, __frame, function __$__5() {
/*   335 */       context = {
/*   336 */         subscription: cli.category("account").lookupSubscriptionId(options.subscription),
/*   337 */         site: {
/*   338 */           name: name
                    }
                  };
/*   342 */       return lookupSiteName(context, __cb(_, __frame, 8, 12, function __$__5() {
/*   343 */         return lookupSiteWebSpace(context, __cb(_, __frame, 9, 12, function __$__5() {
/*   345 */           log.info("Showing details for site");
/*   346 */           log.verbose("Parameters", context);
/*   348 */           return site.doSiteGet(context, __cb(_, __frame, 14, 27, function ___(__0, __1) {
                        siteData = __1;
/*   349 */             return site.doSiteConfigGet(context, __cb(_, __frame, 15, 29, function ___(__0, __2) {
                          configData = __2;
/*   350 */               return site.doRepositoryGet(context, __cb(_, __frame, 16, 33, function ___(__0, __3) {
                            repositoryData = __3;
/*   352 */                 logEachData("Site", siteData);
/*   353 */                 logEachData("Config", configData);
/*   354 */                 log.data("Repository", clean(repositoryData));
                            _();
                          }, true));
                        }, true));
                      }, true));
                    }, true));
                  }, true));
                });
              });
/*   357 */   function lookupSiteName(context, _) {
                var cfg;
                var __frame = {
                  name: "lookupSiteName",
                  line: 357
                };
                return __func(_, this, arguments, lookupSiteName, 1, __frame, function __$lookupSiteName() {
/*   358 */       if ((context.site.name !== undefined)) {
                    return _(null);
                  }
                ;
/*   363 */       return site.readConfig(__cb(_, __frame, 6, 18, function ___(__0, __1) {
                    cfg = __1;
/*   364 */         if ((cfg !== undefined)) {
/*   366 */           context.site.name = cfg.name;
                      return _(null);
                    }
                  ;
/*   370 */         return prompt("Web site name: ", __cb(_, __frame, 13, 28, function ___(__0, __2) {
/*   370 */           context.site.name = __2;
                      _();
                    }, true));
                  }, true));
                });
              };
/*   372 */   site.lookupSiteName = lookupSiteName;
/*   374 */   function lookupSiteWebSpace(context, _) {
                var sites, index;
                var __frame = {
                  name: "lookupSiteWebSpace",
                  line: 374
                };
                return __func(_, this, arguments, lookupSiteWebSpace, 1, __frame, function __$lookupSiteWebSpace() {
/*   375 */       log.verbose("Attempting to locate site ", context.site.name);
/*   376 */       return site.doSitesGet(context, __cb(_, __frame, 2, 20, function ___(__0, __1) {
                    sites = __1;
/*   377 */         for (index in sites) {
/*   378 */           if ((sites[index].Name === context.site.name)) {
/*   379 */             log.verbose("Site located at ", sites[index].WebSpace);
/*   380 */             context.site.webspace = sites[index].WebSpace;
                      }
                    ;
                    };
/*   383 */         if ((context.site.webspace === undefined)) {
/*   384 */           return _(new Error(("Unable to locate site named " + context.site.name)));
                    }
                  ;
                    _();
                  }, true));
                });
              };
/*   387 */   site.lookupSiteWebSpace = lookupSiteWebSpace;
/*   389 */   site.command("delete [name]").description("Delete a web site").option("-s, --subscription <id>", "use the subscription id").execute(function __6(name, options, _) {
                var context, progress, result;
                var __frame = {
                  name: "__6",
                  line: 392
                };
                return __func(_, this, arguments, __6, 2, __frame, function __$__6() {
/*   393 */       context = {
/*   394 */         subscription: cli.category("account").lookupSubscriptionId(options.subscription),
/*   395 */         site: {
/*   396 */           name: name
                    }
                  };
/*   400 */       return lookupSiteName(context, __cb(_, __frame, 8, 12, function __$__6() {
/*   401 */         return lookupSiteWebSpace(context, __cb(_, __frame, 9, 12, function __$__6() {
/*   403 */           log.info("Deleting site", context.site.name);
/*   405 */           progress = cli.progress("Deleting site");
                      return (function ___(__then) {
                        (function ___(_) {
                          __tryCatch(_, function __$__6() {
/*   414 */                 return getChannel().path(context.subscription).path("services").path("webspaces").path(context.site.webspace).path("sites").path(context.site.name).DELETE(__cb(_, __frame, 22, 29, function ___(__0, __1) {
                              result = __1;
                              _(null, null, true);
                            }, true));
                          });
                        })(function ___(__e, __r, __cont) {
                          (function ___(__then) {
                            __tryCatch(_, function __$__6() {
/*   417 */                   progress.end();
                              __then();
                            });
                          })(function ___() {
                            __tryCatch(_, function ___() {
                              if (__cont) {
                                __then();
                              } else {
                                _(__e, __r);
                              };
                            });
                          });
                        });
                      })(function ___() {
                        __tryCatch(_, function __$__6() {
/*   419 */               log.info((("Site " + context.site.name) + " has been deleted"));
                          _();
                        });
                      });
                    }, true));
                  }, true));
                });
              });
/*   423 */   site.command("start [name]").description("Start a web site").option("-s, --subscription <id>", "use the subscription id").execute(function __7(name, options, _) {
                var context, progress, result;
                var __frame = {
                  name: "__7",
                  line: 426
                };
                return __func(_, this, arguments, __7, 2, __frame, function __$__7() {
/*   427 */       context = {
/*   428 */         subscription: cli.category("account").lookupSubscriptionId(options.subscription),
/*   429 */         site: {
/*   430 */           name: name
                    }
                  };
/*   434 */       return lookupSiteName(context, __cb(_, __frame, 8, 12, function __$__7() {
/*   435 */         return lookupSiteWebSpace(context, __cb(_, __frame, 9, 12, function __$__7() {
/*   437 */           log.info("Starting site", context.site.name);
/*   439 */           progress = cli.progress("Updating site state");
                      return (function ___(__then) {
                        (function ___(_) {
                          __tryCatch(_, function __$__7() {
/*   449 */                 return getChannel().path(context.subscription).path("services").path("webspaces").path(context.site.webspace).path("sites").path(context.site.name).header("Content-Type", "application/xml").PUT(function(req) {
/*   450 */                   req.write("<Site xmlns=\"http://schemas.microsoft.com/windowsazure\">");
/*   451 */                   req.write("<HostNames>");
/*   452 */                   req.write("<string xmlns=\"http://schemas.microsoft.com/2003/10/Serialization/Arrays\">");
/*   453 */                   req.write((context.site.name + ".antdf0.antares-test.windows-int.net"));
/*   454 */                   req.write("</string>");
/*   455 */                   req.write("</HostNames>");
/*   456 */                   req.write("<Name>");
/*   457 */                   req.write(context.site.name);
/*   458 */                   req.write("</Name>");
/*   459 */                   req.write("<State>");
/*   460 */                   req.write("Running");
/*   461 */                   req.write("</State>");
/*   462 */                   req.write("</Site>");
/*   464 */                   req.end();
                            }, __cb(_, __frame, 23, 29, function ___(__0, __1) {
                              result = __1;
                              _(null, null, true);
                            }, true));
                          });
                        })(function ___(__e, __r, __cont) {
                          (function ___(__then) {
                            __tryCatch(_, function __$__7() {
/*   468 */                   progress.end();
                              __then();
                            });
                          })(function ___() {
                            __tryCatch(_, function ___() {
                              if (__cont) {
                                __then();
                              } else {
                                _(__e, __r);
                              };
                            });
                          });
                        });
                      })(function ___() {
                        __tryCatch(_, function __$__7() {
/*   471 */               log.info((("Site " + context.site.name) + " has been started"));
                          _();
                        });
                      });
                    }, true));
                  }, true));
                });
              });
/*   474 */   site.command("stop [name]").description("Stop a web site").option("-s, --subscription <id>", "use the subscription id").execute(function __8(name, options, _) {
                var context, progress, result;
                var __frame = {
                  name: "__8",
                  line: 477
                };
                return __func(_, this, arguments, __8, 2, __frame, function __$__8() {
/*   478 */       context = {
/*   479 */         subscription: cli.category("account").lookupSubscriptionId(options.subscription),
/*   480 */         site: {
/*   481 */           name: name
                    }
                  };
/*   485 */       return lookupSiteName(context, __cb(_, __frame, 8, 12, function __$__8() {
/*   486 */         return lookupSiteWebSpace(context, __cb(_, __frame, 9, 12, function __$__8() {
/*   488 */           log.info("Stopping site", context.site.name);
/*   490 */           progress = cli.progress("Updating site state");
                      return (function ___(__then) {
                        (function ___(_) {
                          __tryCatch(_, function __$__8() {
/*   500 */                 return getChannel().path(context.subscription).path("services").path("webspaces").path(context.site.webspace).path("sites").path(context.site.name).header("Content-Type", "application/xml").PUT(function(req) {
/*   501 */                   req.write("<Site xmlns=\"http://schemas.microsoft.com/windowsazure\">");
/*   502 */                   req.write("<HostNames>");
/*   503 */                   req.write("<string xmlns=\"http://schemas.microsoft.com/2003/10/Serialization/Arrays\">");
/*   504 */                   req.write((context.site.name + ".antdf0.antares-test.windows-int.net"));
/*   505 */                   req.write("</string>");
/*   506 */                   req.write("</HostNames>");
/*   507 */                   req.write("<Name>");
/*   508 */                   req.write(context.site.name);
/*   509 */                   req.write("</Name>");
/*   510 */                   req.write("<State>");
/*   511 */                   req.write("Stopped");
/*   512 */                   req.write("</State>");
/*   513 */                   req.write("</Site>");
/*   515 */                   req.end();
                            }, __cb(_, __frame, 23, 29, function ___(__0, __1) {
                              result = __1;
                              _(null, null, true);
                            }, true));
                          });
                        })(function ___(__e, __r, __cont) {
                          (function ___(__then) {
                            __tryCatch(_, function __$__8() {
/*   519 */                   progress.end();
                              __then();
                            });
                          })(function ___() {
                            __tryCatch(_, function ___() {
                              if (__cont) {
                                __then();
                              } else {
                                _(__e, __r);
                              };
                            });
                          });
                        });
                      })(function ___() {
                        __tryCatch(_, function __$__8() {
/*   522 */               log.info((("Site " + context.site.name) + " has been stopped"));
                          _();
                        });
                      });
                    }, true));
                  }, true));
                });
              });
/*   529 */   site.readConfig = function site_readConfig__9(_) {
                var __frame = {
                  name: "site_readConfig__9",
                  line: 529
                };
                return __func(_, this, arguments, site_readConfig__9, 0, __frame, function __$site_readConfig__9() {
/*   531 */       return site.readConfigValue("azure.site.name", __cb(_, __frame, 2, 18, function ___(__0, __2) {
/*   530 */         var __1 = {
/*   531 */           name: __2
                    };
                    return _(null, __1);
                  }, true));
                });
              };
/*   535 */   site.writeConfig = function site_writeConfig__10(cfg, _) {
                var __frame = {
                  name: "site_writeConfig__10",
                  line: 535
                };
                return __func(_, this, arguments, site_writeConfig__10, 1, __frame, function __$site_writeConfig__10() {
/*   536 */       return site.writeConfigValue("azure.site.name", cfg.name, __cb(_, __frame, 1, 8, _, true));
                });
              };
/*   539 */   site.readConfigValue = function site_readConfigValue__11(name, _) {
                var result;
                var __frame = {
                  name: "site_readConfigValue__11",
                  line: 539
                };
                return __func(_, this, arguments, site_readConfigValue__11, 1, __frame, function __$site_readConfigValue__11() {
                  return (function ___(__then) {
                    (function ___(_) {
                      __tryCatch(_, function __$site_readConfigValue__11() {
/*   541 */             return exec(("git config --get " + name), __cb(_, __frame, 2, 25, function ___(__0, __1) {
                          result = __1;
/*   542 */               return _(null, ((result.stdout + result.stderr)).trim());
                        }, true));
                      });
                    })(function ___(err, __result) {
                      __tryCatch(_, function __$site_readConfigValue__11() {
                        if (err) {
/*   545 */               log.silly("Unable to read config", err);
/*   546 */               return _(null, "");
                        }
                         else {
                          _(null, __result);
                        }
                      ;
                      });
                    });
                  })(function ___() {
                    __tryCatch(_, _);
                  });
                });
              };
/*   550 */   site.writeConfigValue = function site_writeConfigValue__12(name, value, _) {
                var __frame = {
                  name: "site_writeConfigValue__12",
                  line: 550
                };
                return __func(_, this, arguments, site_writeConfigValue__12, 2, __frame, function __$site_writeConfigValue__12() {
/*   551 */       return exec(((("git config " + name) + " ") + value), __cb(_, __frame, 1, 8, _, true));
                });
              };
/*   558 */   site.doSitesPost = function(options, callback) {
/*   559 */     log.info("Creating a new web site");
/*   560 */     log.verbose("Subscription", options.subscription);
/*   561 */     log.verbose("Webspace", options.site.webspace);
/*   562 */     log.verbose("Site", options.site.name);
/*   564 */     var progress = cli.progress("Sending site information");
/*   565 */     try {
/*   566 */       getChannel().path(options.subscription).path("services").path("webspaces").path(options.site.webspace).path("sites").header("Content-Type", "application/xml").POST(writers.Site.xml(options.site), function(err, result) {
/*   576 */         if (err) {
/*   577 */           logError("Failed to create site", err);
                    }
/*   578 */          else {
/*   579 */           log.info("Created website at ", clean(result).HostNames);
/*   580 */           log.verbose("Site", clean(result));
                    }
                  ;
/*   582 */         callback(err, result);
                  });
/*   585 */     } finally {
/*   586 */       progress.end();
                };
              };
/*   590 */   site.doRepositoryPost = function(options, callback) {
/*   591 */     log.info("Initializing repository");
/*   592 */     log.verbose("Subscription", options.subscription);
/*   593 */     log.verbose("Webspace", options.site.webspace);
/*   594 */     log.verbose("Site", options.site.name);
/*   596 */     var progress = cli.progress("Updating site information");
/*   597 */     try {
/*   598 */       getChannel().path(options.subscription).path("services").path("webspaces").path(options.site.webspace).path("sites").path(options.site.name).path("repository").POST("", function(err, result) {
/*   609 */         if (err) {
/*   610 */           logError("Failed to initialize repository", err);
                    }
/*   611 */          else {
/*   612 */           log.info("Repository initialized");
                    }
                  ;
/*   614 */         callback(err, result);
                  });
/*   617 */     } finally {
/*   618 */       progress.end();
                };
              };
/*   622 */   site.doSpacesGet = function site_doSpacesGet__13(options, _) {
                var progress, result;
                var __frame = {
                  name: "site_doSpacesGet__13",
                  line: 622
                };
                return __func(_, this, arguments, site_doSpacesGet__13, 1, __frame, function __$site_doSpacesGet__13() {
/*   623 */       log.verbose("Subscription", options.subscription);
/*   625 */       progress = cli.progress("Enumerating locations");
                  return (function ___(__then) {
                    (function ___(_) {
                      __tryCatch(_, function __$site_doSpacesGet__13() {
/*   632 */             return getChannel().path(options.subscription).path("services").path("webspaces").path("").GET(__cb(_, __frame, 10, 25, function ___(__0, __1) {
                          result = __1;
/*   634 */               log.json("silly", result);
/*   635 */               return _(null, toArray(result.WebSpace));
                        }, true));
                      });
                    })(function ___(__e, __r, __cont) {
                      (function ___(__then) {
                        __tryCatch(_, function __$site_doSpacesGet__13() {
/*   638 */               progress.end();
                          __then();
                        });
                      })(function ___() {
                        __tryCatch(_, function ___() {
                          if (__cont) {
                            __then();
                          } else {
                            _(__e, __r);
                          };
                        });
                      });
                    });
                  })(function ___() {
                    __tryCatch(_, _);
                  });
                });
              };
/*   642 */   site.doSitesGet = function site_doSitesGet__14(options, _) {
                var spaces, channel, progress, result, sites;
                var __frame = {
                  name: "site_doSitesGet__14",
                  line: 642
                };
                return __func(_, this, arguments, site_doSitesGet__14, 1, __frame, function __$site_doSitesGet__14() {
/*   643 */       log.verbose("Subscription", options.subscription);
/*   645 */       return site.doSpacesGet(options, __cb(_, __frame, 3, 21, function ___(__0, __2) {
                    spaces = __2;
/*   649 */         channel = getChannel().path(options.subscription).path("services/webspaces");
/*   651 */         progress = cli.progress("Enumerating sites");
                    return (function ___(__then) {
                      (function ___(_) {
                        __tryCatch(_, function __$site_doSitesGet__14() {
/*   653 */               return async.map(spaces, function __1(webspace, _) {
                            var __frame = {
                              name: "__1",
                              line: 655
                            };
                            return __func(_, this, arguments, __1, 1, __frame, function __$__1() {
/*   660 */                   return channel.path(webspace.Name).path("sites").path("").GET(__cb(_, __frame, 5, 27, _, true));
                            });
                          }, __cb(_, __frame, 11, 25, function ___(__0, __3) {
                            result = __3;
/*   664 */                 sites = [];
/*   665 */                 result.forEach(function(item) {
/*   666 */                   sites = sites.concat(toArray(item.Site));
                            });
/*   668 */                 result = sites;
/*   670 */                 log.json("verbose", sites);
/*   671 */                 return _(null, sites);
                          }, true));
                        });
                      })(function ___(__e, __r, __cont) {
                        (function ___(__then) {
                          __tryCatch(_, function __$site_doSitesGet__14() {
/*   674 */                 progress.end();
                            __then();
                          });
                        })(function ___() {
                          __tryCatch(_, function ___() {
                            if (__cont) {
                              __then();
                            } else {
                              _(__e, __r);
                            };
                          });
                        });
                      });
                    })(function ___() {
                      __tryCatch(_, _);
                    });
                  }, true));
                });
              };
/*   678 */   site.doSiteGet = function(options, callback) {
/*   679 */     var progress = cli.progress("Retrieving site information");
/*   680 */     try {
/*   681 */       getChannel().path(options.subscription).path("services").path("webspaces").path(options.site.webspace).path("sites").path(options.site.name).GET(function(err, result) {
/*   690 */         if (err) {
/*   691 */           logError("Failed to get site info", err);
                    }
/*   692 */          else {
/*   693 */           log.verbose("Site", clean(result));
                    }
                  ;
/*   695 */         callback(err, result);
                  });
/*   698 */     } finally {
/*   699 */       progress.end();
                };
              };
/*   703 */   site.doSiteConfigGet = function(options, callback) {
/*   704 */     var progress = cli.progress("Retrieving site information");
/*   705 */     try {
/*   706 */       getChannel().path(options.subscription).path("services").path("webspaces").path(options.site.webspace).path("sites").path(options.site.name).path("config").GET(function(err, result) {
/*   716 */         if (err) {
/*   717 */           logError("Failed to get site config info", err);
                    }
/*   718 */          else {
/*   719 */           log.verbose("SiteConfig", clean(result));
                    }
                  ;
/*   721 */         callback(err, result);
                  });
/*   724 */     } finally {
/*   725 */       progress.end();
                };
              };
/*   729 */   site.doRepositoryGet = function(options, callback) {
/*   730 */     var progress = cli.progress("Retrieving site information");
/*   731 */     try {
/*   732 */       getChannel().path(options.subscription).path("services").path("webspaces").path(options.site.webspace).path("sites").path(options.site.name).path("repository").GET(function(err, result) {
/*   742 */         if (result) {
/*   743 */           log.verbose("Repository", clean(result));
                    }
                  ;
/*   745 */         callback(err, clean(result));
                  });
/*   748 */     } finally {
/*   749 */       progress.end();
                };
              };
/*   753 */   site.doPublishingUsersGet = function site_doPublishingUsersGet__15(options, _) {
                var progress, publishingUsers;
                var __frame = {
                  name: "site_doPublishingUsersGet__15",
                  line: 753
                };
                return __func(_, this, arguments, site_doPublishingUsersGet__15, 1, __frame, function __$site_doPublishingUsersGet__15() {
/*   754 */       progress = cli.progress("Retrieving user information");
                  return (function ___(__then) {
                    (function ___(_) {
                      __tryCatch(_, function __$site_doPublishingUsersGet__15() {
/*   762 */             return getChannel().path(options.subscription).path("services").path("webspaces").path("").query("properties", "publishingUsers").GET(__cb(_, __frame, 9, 40, function ___(__0, __1) {
/*   756 */               publishingUsers = clean(__1);
/*   764 */               log.verbose("PublishingUsers", publishingUsers);
/*   765 */               return _(null, publishingUsers);
                        }, true));
                      });
                    })(function ___(__e, __r, __cont) {
                      (function ___(__then) {
                        __tryCatch(_, function __$site_doPublishingUsersGet__15() {
/*   768 */               progress.end();
                          __then();
                        });
                      })(function ___() {
                        __tryCatch(_, function ___() {
                          if (__cont) {
                            __then();
                          } else {
                            _(__e, __r);
                          };
                        });
                      });
                    });
                  })(function ___() {
                    __tryCatch(_, _);
                  });
                });
              };
/*   776 */   var writers = {
/*   777 */     Site: {
/*   778 */       xml: function(site) {
/*   779 */         return function(req) {
/*   780 */           req.write("<Site xmlns=\"http://schemas.microsoft.com/windowsazure\">");
/*   781 */           req.write("<HostNames>");
/*   782 */           req.write("<string xmlns=\"http://schemas.microsoft.com/2003/10/Serialization/Arrays\">");
/*   783 */           req.write((site.name + ".antdf0.antares-test.windows-int.net"));
/*   784 */           req.write("</string>");
/*   786 */           if (site.hostname) {
/*   787 */             req.write("<string xmlns=\"http://schemas.microsoft.com/2003/10/Serialization/Arrays\">");
/*   788 */             req.write(site.hostname);
/*   789 */             req.write("</string>");
                      }
                    ;
/*   791 */           req.write("</HostNames>");
/*   792 */           req.write("<Name>");
/*   793 */           req.write(site.name);
/*   794 */           req.write("</Name>");
/*   795 */           req.write("</Site>");
/*   797 */           req.end();
                    };
                  }
                }
              };
/*   803 */   function clean(source) {
/*   804 */     if ((typeof (source) === "string")) {
/*   805 */       return source;
                }
              ;
/*   808 */     var target = {
                };
/*   809 */     var hasString = false;
/*   810 */     var hasNonString = false;
/*   811 */     var stringValue = "";
/*   813 */     for (var prop in source) {
/*   814 */       if ((prop == "@")) {
/*   815 */         continue;
                  }
/*   816 */        else {
/*   817 */         if ((((prop === "#") || (prop === "string")) || (prop.substring((prop.length - 7)) === ":string"))) {
/*   818 */           hasString = true;
/*   819 */           stringValue = source[prop];
                    }
/*   820 */          else {
/*   821 */           hasNonString = true;
                    }
                  ;
/*   823 */         target[prop] = clean(source[prop]);
                  }
                ;
                };
/*   826 */     if ((hasString && !hasNonString)) {
/*   827 */       return stringValue;
                }
              ;
/*   829 */     return target;
              };
/*   832 */   function logEachData(title, data) {
/*   833 */     var cleaned = clean(data);
/*   834 */     for (var property in cleaned) {
/*   835 */       log.data(((title + " ") + property), cleaned[property]);
                };
              };
/*   839 */   function logError(message, err) {
/*   840 */     if ((arguments.length == 1)) {
/*   841 */       err = message;
/*   842 */       message = undefined;
                }
/*   843 */      else {
/*   844 */       log.error(message);
                }
              ;
/*   847 */     if (err) {
/*   848 */       if (err.message) {
/*   850 */         log.verbose("stack", err.stack);
/*   851 */         log.json("silly", err);
                  }
/*   853 */        else if (err.Message) {
/*   855 */         log.json("verbose", clean(err));
                  }
/*   857 */        else {
                  
                  }
                  
                ;
                }
              ;
              };
/*   863 */   function isArray(testObject) {
/*   864 */     return (((testObject && !(testObject.propertyIsEnumerable("length"))) && (typeof testObject === "object")) && (typeof testObject.length === "number"));
              };
/*   867 */   function toArray(testObject) {
/*   868 */     return (isArray(testObject) ? testObject : ((typeof testObject === "undefined") ? [] : [testObject,]));
              };
/*   871 */   function endsWith(str, suffix) {
/*   872 */     return (str.indexOf(suffix, (str.length - suffix.length)) !== -1);
              };
/*   875 */   function exec(cmd, cb) {
/*   876 */     child_process.exec(cmd, function(err, stdout, stderr) {
/*   877 */       cb(err, {
/*   878 */         stdout: stdout,
/*   879 */         stderr: stderr
                  });
                });
              };
            };
