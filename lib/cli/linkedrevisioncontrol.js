/*** Generated by streamline 0.4.5 (callbacks) - DO NOT EDIT ***/ var __rt=require('streamline/lib/callbacks/runtime').runtime(__filename),__func=__rt.__func,__cb=__rt.__cb,__tryCatch=__rt.__tryCatch,__forIn=__rt.__forIn; var url = require("url");















var fs = require("fs");
var util = require("util");
var child_process = require("child_process");
var GitHubApi = require("github");

var utils = require("./utils");

exports.createClient = function(cli, name) {
  switch (name) {
  case "github": return new GithubClient(cli);
    break;
  case "git":
    return new GitClient(cli);
    break;
    default:
    throw new Error("Invalid client");
  };};



function LinkedRevisionControlClient(cli) {
  this.cli = cli;};


LinkedRevisionControlClient.prototype.determineIfCurrentDirectoryIsGitWorkingTree = function LinkedRevisionControlClient_prototype_determineIfCurrentDirectoryIsGitWorkingTree__1(context, _) { var isInsideWorkTree, lines, __this = this; var __frame = { name: "LinkedRevisionControlClient_prototype_determineIfCurrentDirectoryIsGitWorkingTree__1", line: 41 }; return __func(_, this, arguments, LinkedRevisionControlClient_prototype_determineIfCurrentDirectoryIsGitWorkingTree__1, 1, __frame, function __$LinkedRevisionControlClient_prototype_determineIfCurrentDirectoryIsGitWorkingTree__1() {
    __this.cli.output.silly("determineIfCurrentDirectoryIsGitWorkingTree"); return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$LinkedRevisionControlClient_prototype_determineIfCurrentDirectoryIsGitWorkingTree__1() {


          return __this._exec("git rev-parse --git-dir", __cb(_, __frame, 4, 27, function ___(__0, __1) { isInsideWorkTree = __1;
            lines = (isInsideWorkTree.stdout + isInsideWorkTree.stderr);
            context.flags.isGitWorkingTree = lines.split("\n").some(function(line) {
              return (line === ".git"); }); __then(); }, true)); }); })(function ___(err, __result) { __tryCatch(_, function __$LinkedRevisionControlClient_prototype_determineIfCurrentDirectoryIsGitWorkingTree__1() { if (err) {


            context.flags.isGitWorkingTree = false; __then(); } else { _(null, __result); } ; }); }); })(function ___() { __tryCatch(_, _); }); });};



LinkedRevisionControlClient.prototype.initGitOnCurrentDirectory = function LinkedRevisionControlClient_prototype_initGitOnCurrentDirectory__2(context, scaffold, _) { var __this = this; var __frame = { name: "LinkedRevisionControlClient_prototype_initGitOnCurrentDirectory__2", line: 55 }; return __func(_, this, arguments, LinkedRevisionControlClient_prototype_initGitOnCurrentDirectory__2, 2, __frame, function __$LinkedRevisionControlClient_prototype_initGitOnCurrentDirectory__2() {
    __this.cli.output.silly("initGitOnCurrentDirectoryIfNeeded");
    if (context.flags.isGitWorkingTree) { return _(null); } ;



    __this.cli.output.info("Executing `git init`");
    return __this._exec("git init", __cb(_, __frame, 7, 2, function __$LinkedRevisionControlClient_prototype_initGitOnCurrentDirectory__2() { return (function __$LinkedRevisionControlClient_prototype_initGitOnCurrentDirectory__2(__then) {

        if ((scaffold && !utils.pathExistsSync(".gitignore"))) {
          __this.cli.output.info("Creating default .gitignore file");
          return fs.writeFile(".gitignore", "node_modules\nazure_error", __cb(_, __frame, 11, 4, __then, true)); } else { __then(); } ; })(function __$LinkedRevisionControlClient_prototype_initGitOnCurrentDirectory__2() {


        context.flags.isGitWorkingTree = true; _(); }); }, true)); });};


LinkedRevisionControlClient.prototype._exec = function(cmd, cb) {
  child_process.exec(cmd, function(err, stdout, stderr) {
    cb(err, {
      stdout: stdout,
      stderr: stderr }); });};




function GitClient(cli) {
  GitClient.super_.call(this, cli);};


util.inherits(GitClient, LinkedRevisionControlClient);

GitClient.prototype.init = function GitClient_prototype_init__3(context, _) { var __this = this; var __frame = { name: "GitClient_prototype_init__3", line: 87 }; return __func(_, this, arguments, GitClient_prototype_init__3, 1, __frame, function __$GitClient_prototype_init__3() {
    return __this.determineIfCurrentDirectoryIsGitWorkingTree(context, __cb(_, __frame, 1, 2, function __$GitClient_prototype_init__3() {
      return __this.initGitOnCurrentDirectory(context, true, __cb(_, __frame, 2, 2, _, true)); }, true)); });};


GitClient.prototype.deploy = function GitClient_prototype_deploy__4(context, _) { var __frame = { name: "GitClient_prototype_deploy__4", line: 92 }; return __func(_, this, arguments, GitClient_prototype_deploy__4, 1, __frame, _);};



function GithubClient(cli) {
  GithubClient.super_.call(this, cli);

  this.client = new GitHubApi({ version: "3.0.0" });};


util.inherits(GithubClient, LinkedRevisionControlClient);

GithubClient.prototype.authenticate = function(username, password) {
  this.client.authenticate({
    type: "basic",
    username: username,
    password: password });};



GithubClient.prototype.init = function GithubClient_prototype_init__5(context, _) { var repositories, parsedRepositoryUri, pathParts, owner, name, localRepositories, __this = this; var __frame = { name: "GithubClient_prototype_init__5", line: 112 }; return __func(_, this, arguments, GithubClient_prototype_init__5, 1, __frame, function __$GithubClient_prototype_init__5() {
    return __this.determineIfCurrentDirectoryIsGitWorkingTree(context, __cb(_, __frame, 1, 2, function __$GithubClient_prototype_init__5() {
      return __this.initGitOnCurrentDirectory(context, false, __cb(_, __frame, 2, 2, function __$GithubClient_prototype_init__5() {

        return __this.getRepositories(context.username, __cb(_, __frame, 4, 21, function ___(__0, __1) { repositories = __1;

          return __this._getRemoteUri(__cb(_, __frame, 6, 22, function ___(__0, __2) { context.remoteUri = __2;
            if ((!context.flags.forceRepositorySelection && context.remoteUri)) {
              parsedRepositoryUri = url.parse(context.remoteUri);
              pathParts = parsedRepositoryUri.pathname.split("/");
              if ((pathParts.length === 3)) {
                owner = pathParts[1];
                name = pathParts[2].split(".")[0];
                localRepositories = repositories.filter(function(repository) {
                  return ((repository.name === name) && (repository.owner.login === owner)); });


                if ((localRepositories && (localRepositories.length > 0))) {
                  context.repository = localRepositories[0]; } ; } ; } ; return (function __$GithubClient_prototype_init__5(__then) {




              if (!context.repository) {
                __this.cli.output.help("Choose a repository");
                return choose(__this.cli, repositories.map(function(repository) {
                  return repository.full_name; }), __cb(_, __frame, 25, 38, function ___(__0, __3) { context.repository = repositories[__3]; __then(); }, true)); } else { __then(); } ; })(_); }, true)); }, true)); }, true)); }, true)); });};




GithubClient.prototype.deploy = function GithubClient_prototype_deploy__6(context, _) { var parsedRepositoryUri, hookUrl, gitUri, __this = this; var __frame = { name: "GithubClient_prototype_deploy__6", line: 143 }; return __func(_, this, arguments, GithubClient_prototype_deploy__6, 1, __frame, function __$GithubClient_prototype_deploy__6() {
    parsedRepositoryUri = url.parse(context.repositoryUri);
    parsedRepositoryUri.auth = context.repositoryAuth;
    parsedRepositoryUri.pathname = "/deploy";
    hookUrl = url.format(parsedRepositoryUri);
    return context.lvcClient.createOrUpdateHook(context.repository.owner.login, context.repository.name, hookUrl, __cb(_, __frame, 5, 2, function __$GithubClient_prototype_deploy__6() {




      gitUri = context.repository.git_url; return (function __$GithubClient_prototype_deploy__6(__then) {
        if ((context.remoteUri && (context.remoteUri.toLowerCase() !== gitUri.toLowerCase()))) {
          __this.cli.output.verbose("Removing existing azure remote alias");
          return __this._exec("git remote rm azure", __cb(_, __frame, 13, 4, function __$GithubClient_prototype_deploy__6() {
            context.remoteUri = null; __then(); }, true)); } else { __then(); } ; })(function __$GithubClient_prototype_deploy__6() { return (function __$GithubClient_prototype_deploy__6(__then) {


          if (!context.remoteUri) {

            __this.cli.output.info((("Executing `git remote add azure " + gitUri) + "`"));
            return __this._exec(("git remote add azure " + gitUri), __cb(_, __frame, 20, 4, __then, true)); } else { __then(); } ; })(_); }); }, true)); });};



GithubClient.prototype.getRepositories = function GithubClient_prototype_getRepositories__7(username, _) { var progress, userRepos, orgs, orgRepos, i, org, __this = this;



  function sortFunction(repositoryA, repositoryB) {
    return repositoryA.full_name.toLowerCase().localeCompare(repositoryB.full_name.toLowerCase()); };



  function filterPrivate(repository) {
    return (repository["private"] !== true); }; var __frame = { name: "GithubClient_prototype_getRepositories__7", line: 167 }; return __func(_, this, arguments, GithubClient_prototype_getRepositories__7, 1, __frame, function __$GithubClient_prototype_getRepositories__7() { progress = __this.cli.progress("Retrieving repositories"); userRepos = []; return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$GithubClient_prototype_getRepositories__7() {



          return __this.client.repos.getFromUser({ user: username }, __cb(_, __frame, 14, 16, function ___(__0, __3) { userRepos = __3.filter(filterPrivate).sort(sortFunction);



            return __this.client.orgs.getFromUser({ user: username }, __cb(_, __frame, 18, 15, function ___(__0, __4) { orgs = __4; return (function __$GithubClient_prototype_getRepositories__7(__then) {
                if (orgs) {
                  orgRepos = [];
                  var __1 = __forIn(orgs); var __2 = 0; return (function ___(__break) { var __more; var __loop = __cb(_, __frame, 0, 0, function __$GithubClient_prototype_getRepositories__7() { __more = false; var __8 = (__2 < __1.length); if (__8) { i = __1[__2++]; return (function __$GithubClient_prototype_getRepositories__7(__then) {
                          if (orgs.hasOwnProperty(i)) {
                            org = orgs[i]; return (function __$GithubClient_prototype_getRepositories__7(__then) {
                              if (org.login) {
                                return __this.client.repos.getFromOrg({ org: org.login }, __cb(_, __frame, 25, 20, function ___(__0, __5) { repos = __5;

                                  orgRepos = orgRepos.concat(repos); __then(); }, true)); } else { __then(); } ; })(__then); } else { __then(); } ; })(function __$GithubClient_prototype_getRepositories__7() { while (__more) { __loop(); }; __more = true; }); } else { __break(); } ; }); do { __loop(); } while (__more); __more = true; })(__then); } else { __then(); } ; })(function __$GithubClient_prototype_getRepositories__7() {




                orgRepos = orgRepos.filter(filterPrivate).sort(sortFunction);

                userRepos = userRepos.concat(orgRepos); _(null, null, true); }); }, true)); }, true)); }); })(function ___(__e, __r, __cont) { (function ___(__then) { __tryCatch(_, function __$GithubClient_prototype_getRepositories__7() {

            progress.end(); __then(); }); })(function ___() { __tryCatch(_, function ___() { if (__cont) { __then(); } else { _(__e, __r); }; }); }); }); })(function ___() { __tryCatch(_, function __$GithubClient_prototype_getRepositories__7() {


        return _(null, userRepos); }); }); });};


GithubClient.prototype.createOrUpdateHook = function GithubClient_prototype_createOrUpdateHook__8(username, repository, deployUri, _) { var hook, hooks, parsedDeployUri, existingHook, __this = this; var __frame = { name: "GithubClient_prototype_createOrUpdateHook__8", line: 209 }; return __func(_, this, arguments, GithubClient_prototype_createOrUpdateHook__8, 3, __frame, function __$GithubClient_prototype_createOrUpdateHook__8() {
    hook = {
      name: "web",
      user: username,
      repo: repository,
      active: true,
      events: ["push",],
      config: {
        url: deployUri,
        content_type: "json" } };



    return __this.getHooks(username, repository, __cb(_, __frame, 13, 14, function ___(__0, __1) { hooks = __1;
      parsedDeployUri = url.parse(deployUri);







      existingHook = hooks.filter(function(hook) { if (hook.config) { return ((hook.name === "web") && (url.parse(hook.config.url).hostname.toLowerCase() === parsedDeployUri.hostname.toLowerCase())); } ; return false; })[0]; return (function __$GithubClient_prototype_createOrUpdateHook__8(__then) {

        if (existingHook) { return (function __$GithubClient_prototype_createOrUpdateHook__8(__then) {

            if ((existingHook.config.url.toLowerCase() !== hook.config.url.toLowerCase())) {
              existingHook.config.url = hook.config.url;
              hook = existingHook;
              hook.user = username;
              hook.repo = repository;
              return __this.updateHook(hook, __cb(_, __frame, 31, 13, function ___(__0, __2) { hook = __2;
                return __this.testHook(hook, __cb(_, __frame, 32, 6, __then, true)); }, true)); } else {

              __this.cli.output.info("Link already established"); __then(); } ; })(__then); } else {


          return __this.createHook(hook, __cb(_, __frame, 37, 11, function ___(__0, __3) { hook = __3;
            hook.user = username;
            hook.repo = repository;
            return __this.testHook(hook, __cb(_, __frame, 40, 4, __then, true)); }, true)); } ; })(_); }, true)); });};



GithubClient.prototype.createHook = function GithubClient_prototype_createHook__9(hook, _) { var progress, __this = this; var __frame = { name: "GithubClient_prototype_createHook__9", line: 253 }; return __func(_, this, arguments, GithubClient_prototype_createHook__9, 1, __frame, function __$GithubClient_prototype_createHook__9() {
    progress = __this.cli.progress("Creating new hook"); return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$GithubClient_prototype_createHook__9() {


          return __this.client.repos.createHook(hook, __cb(_, __frame, 4, 11, _, true)); }); })(function ___(__e, __r, __cont) { (function ___(__then) { __tryCatch(_, function __$GithubClient_prototype_createHook__9() {

            progress.end(); __then(); }); })(function ___() { __tryCatch(_, function ___() { if (__cont) { __then(); } else { _(__e, __r); }; }); }); }); })(function ___() { __tryCatch(_, _); }); });};



GithubClient.prototype.updateHook = function GithubClient_prototype_updateHook__10(hook, _) { var progress, __this = this; var __frame = { name: "GithubClient_prototype_updateHook__10", line: 263 }; return __func(_, this, arguments, GithubClient_prototype_updateHook__10, 1, __frame, function __$GithubClient_prototype_updateHook__10() {
    progress = __this.cli.progress("Updating hook"); return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$GithubClient_prototype_updateHook__10() {


          return __this.client.repos.updateHook(hook, __cb(_, __frame, 4, 11, _, true)); }); })(function ___(__e, __r, __cont) { (function ___(__then) { __tryCatch(_, function __$GithubClient_prototype_updateHook__10() {

            progress.end(); __then(); }); })(function ___() { __tryCatch(_, function ___() { if (__cont) { __then(); } else { _(__e, __r); }; }); }); }); })(function ___() { __tryCatch(_, _); }); });};



GithubClient.prototype.testHook = function GithubClient_prototype_testHook__11(hook, _) { var progress, __this = this; var __frame = { name: "GithubClient_prototype_testHook__11", line: 273 }; return __func(_, this, arguments, GithubClient_prototype_testHook__11, 1, __frame, function __$GithubClient_prototype_testHook__11() {
    progress = __this.cli.progress("Testing new hook"); return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$GithubClient_prototype_testHook__11() {


          return __this.client.repos.testHook(hook, __cb(_, __frame, 4, 4, function __$GithubClient_prototype_testHook__11() { _(null, null, true); }, true)); }); })(function ___(__e, __r, __cont) { (function ___(__then) { __tryCatch(_, function __$GithubClient_prototype_testHook__11() {

            progress.end(); __then(); }); })(function ___() { __tryCatch(_, function ___() { if (__cont) { __then(); } else { _(__e, __r); }; }); }); }); })(function ___() { __tryCatch(_, _); }); });};



GithubClient.prototype.getHooks = function GithubClient_prototype_getHooks__12(username, repository, _) { var progress, __this = this; var __frame = { name: "GithubClient_prototype_getHooks__12", line: 283 }; return __func(_, this, arguments, GithubClient_prototype_getHooks__12, 2, __frame, function __$GithubClient_prototype_getHooks__12() {
    progress = __this.cli.progress("Retrieving website hooks"); return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$GithubClient_prototype_getHooks__12() {


          return __this.client.repos.getHooks({
            user: username,
            repo: repository }, __cb(_, __frame, 4, 11, _, true)); }); })(function ___(__e, __r, __cont) { (function ___(__then) { __tryCatch(_, function __$GithubClient_prototype_getHooks__12() {


            progress.end(); __then(); }); })(function ___() { __tryCatch(_, function ___() { if (__cont) { __then(); } else { _(__e, __r); }; }); }); }); })(function ___() { __tryCatch(_, _); }); });};



GithubClient.prototype._getRemoteUri = function GithubClient_prototype__getRemoteUri__13(_) { var progress, originUri, __this = this; var __frame = { name: "GithubClient_prototype__getRemoteUri__13", line: 296 }; return __func(_, this, arguments, GithubClient_prototype__getRemoteUri__13, 0, __frame, function __$GithubClient_prototype__getRemoteUri__13() {
    progress = __this.cli.progress("Retrieving local git repositories");
    originUri = null; return (function ___(__then) { (function ___(_) { __tryCatch(_, function __$GithubClient_prototype__getRemoteUri__13() {


          return __this._getRemote("azure", __cb(_, __frame, 5, 16, function ___(__0, __1) { originUri = __1; return (function __$GithubClient_prototype__getRemoteUri__13(__then) {
              if (!originUri) {
                return __this._getRemote("origin", __cb(_, __frame, 7, 18, function ___(__0, __2) { originUri = __2; __then(); }, true)); } else { __then(); } ; })(function __$GithubClient_prototype__getRemoteUri__13() { _(null, null, true); }); }, true)); }); })(function ___(__e, __r, __cont) { (function ___(__then) { __tryCatch(_, function __$GithubClient_prototype__getRemoteUri__13() {


            progress.end(); __then(); }); })(function ___() { __tryCatch(_, function ___() { if (__cont) { __then(); } else { _(__e, __r); }; }); }); }); })(function ___() { __tryCatch(_, function __$GithubClient_prototype__getRemoteUri__13() {


        return _(null, originUri); }); }); });};


GithubClient.prototype._getRemote = function GithubClient_prototype__getRemote__14(name, _) { var remotes, origin, __this = this; var __frame = { name: "GithubClient_prototype__getRemote__14", line: 312 }; return __func(_, this, arguments, GithubClient_prototype__getRemote__14, 1, __frame, function __$GithubClient_prototype__getRemote__14() {
    return __this._exec("git remote -v", __cb(_, __frame, 1, 16, function ___(__0, __1) { remotes = __1;
      origin = ((remotes.stdout + remotes.stderr)).split("\n").filter(function(item) {
        return item.split("	").some(function(it) {
          return (it === name); }); });



      if ((origin && (origin.length > 0))) {
        return _(null, origin[0].split("	")[1].split(" ")[0]); } ;


      return _(null, null); }, true)); });};


function choose(cli, data, callback) {
  cli.choose(data, function(x) { callback(undefined, x); });};